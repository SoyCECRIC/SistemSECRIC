<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservar Espacio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="icon" type="image/png" href="/img/Logo 1.png">
</head>
<body class="d-flex flex-column min-vh-100">
    
    <!-- Sidebar (Modal) -->
    <aside id="sidebar" class="position-fixed vh-100 bg-dark text-white d-flex flex-column p-3 sidebar d-none">
        <div class="text-center mb-4">
            <a href="/dashboard">
                <img id="sidebar-user-img" src="/img/default-profile.png" alt="Foto de perfil" class="rounded-circle mb-2 user-img" style="width: 80px; height: 80px;">
            </a>
            <h6 id="user-name-sidebar">Usuario</h6>
        </div>
        <nav class="nav flex-column flex-grow-1">
            <a class="nav-link text-white d-flex align-items-center mb-2" href="/dashboard">
                <i class="fas fa-home me-2"></i> Inicio
            </a>
            <a class="nav-link text-white d-flex align-items-center mb-2" href="/reserve">
                <i class="fas fa-calendar-plus me-2"></i> Reservar
            </a>
            <a class="nav-link text-white d-flex align-items-center mb-2" href="/reservations/manage">
                <i class="fas fa-list me-2"></i> Administrar Reservas
            </a>
            <a class="nav-link text-white d-flex align-items-center mb-2" href="/my-reservations">
                <i class="fas fa-list me-2"></i> Mis Reservas
            </a>
            <a class="nav-link text-white d-flex align-items-center mb-2" href="/profile/edit">
                <i class="fas fa-user-edit me-2"></i> Editar Perfil
            </a>
            <a class="nav-link text-white d-flex align-items-center mb-2" href="/users/manage">
                <i class="fas fa-users me-2"></i> Administrar Cuentas
            </a>
            <hr class="text-secondary">
            <a class="nav-link text-white d-flex align-items-center mt-auto" href="/logout">
                <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
            </a>
        </nav>
    </aside>

    <!-- Overlay -->
    <div id="overlay" class="position-fixed top-0 start-0 w-100 h-100 overlay d-none"></div>

    <!-- Botón toggle -->
    <button id="sidebarToggle" class="btn btn-primary rounded-circle toggle-btn" aria-label="Abrir o cerrar menú">
        <i class="fas fa-bars"></i>
    </button>

    <main class="container-fluid p-4 flex-grow-1" id="main-content">
        <div class="card shadow-sm p-4 mx-auto" style="max-width: 600px;">
            <h3 class="mb-4 text-center">Reservar Espacio</h3>
            <div id="reservation-message" class="alert d-none mb-3" role="alert"></div>
            <form id="reservationForm">
                <div class="mb-3 position-relative">
                    <select class="form-select" id="teacher" name="teacherId" required>
                        <option value="">Selecciona un docente</option>
                    </select>
                    <label for="teacher" class="form-label position-absolute top-0 start-0 translate-middle-y ps-2">Nombre del Docente</label>
                </div>
                <div class="mb-3 position-relative">
                    <input type="text" class="form-control" id="group-grade" name="groupGrade" placeholder=" " required>
                    <label for="group-grade" class="form-label position-absolute top-0 start-0 translate-middle-y ps-2">Grupo y Grado</label>
                </div>
                <div class="mb-3 position-relative">
                    <input type="date" class="form-control" id="date" name="date" required min="2025-09-26">
                    <label for="date" class="form-label position-absolute top-0 start-0 translate-middle-y ps-2">Fecha</label>
                </div>
                <div class="mb-3 position-relative">
                    <select class="form-select" id="entry-time" name="entryTime" required>
                        <option value="">Selecciona hora de entrada</option>
                    </select>
                    <label for="entry-time" class="form-label position-absolute top-0 start-0 translate-middle-y ps-2">Hora de Entrada</label>
                </div>
                <div class="mb-3 position-relative">
                    <select class="form-select" id="exit-time" name="exitTime" required>
                        <option value="">Selecciona hora de salida</option>
                    </select>
                    <label for="exit-time" class="form-label position-absolute top-0 start-0 translate-middle-y ps-2">Hora de Salida</label>
                </div>
                <div class="mb-3 position-relative">
                    <textarea class="form-control" id="motive" name="motive" placeholder=" " required></textarea>
                    <label for="motive" class="form-label position-absolute top-0 start-0 translate-middle-y ps-2">Motivo de Reserva</label>
                </div>
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-calendar-check me-2"></i> Reservar</button>
            </form>
        </div>
    </main>
    <!-- Footer -->
    <footer class="bg-dark text-white py-3 mt-auto">
        <div class="container d-flex justify-content-between align-items-center">
            <p class="mb-0">&copy; 2025 Sistema de Reservas. Todos los derechos reservados.</p>
            <img src="/img/Gohe.png" alt="Logo del autor" class="img-fluid footer-logo">
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const userNameElement = document.getElementById('user-name-sidebar');
            const userImgElement = document.getElementById('sidebar-user-img');
            if (userNameElement && userImgElement) {
                loadUserData();
            } else {
                console.error('Elementos del sidebar no encontrados');
            }
            loadTeachersSelect();
            populateTimes();

            // Actualizar horarios al cambiar la fecha o la hora de entrada
            document.getElementById('date').addEventListener('change', updateAvailableTimes);
            document.getElementById('entry-time').addEventListener('change', updateExitTimes);
        });

        const allTimes = ["07:30", "08:15", "09:00", "09:45", "10:30", "11:15", "12:00", "12:45", "13:30", "14:15"];
        const entryTimes = ["07:30", "08:15", "09:00", "09:45", "10:30", "11:15", "12:00", "12:45", "13:30"];
        const exitTimes = ["08:15", "09:00", "09:45", "10:30", "11:15", "12:00", "12:45", "13:30", "14:15"];

        function populateTimes() {
            const entrySelect = document.getElementById('entry-time');
            entrySelect.innerHTML = '<option value="">Selecciona hora de entrada</option>';
            entryTimes.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                entrySelect.appendChild(option);
            });
            updateExitTimes();
        }

        async function updateAvailableTimes() {
            const date = document.getElementById('date').value;
            const entrySelect = document.getElementById('entry-time');
            const exitSelect = document.getElementById('exit-time');
            entrySelect.innerHTML = '<option value="">Selecciona hora de entrada</option>';
            exitSelect.innerHTML = '<option value="">Selecciona hora de salida</option>';

            let reservedTimes = [];
            if (date) {
                try {
                    const res = await fetch(`/reservations/date?date=${date}`, { credentials: 'include' });
                    if (!res.ok) throw new Error('Error al obtener reservas');
                    const reservations = await res.json();
                    reservedTimes = reservations.map(res => ({
                        entry: res.entryTime,
                        exit: res.exitTime
                    }));
                } catch (err) {
                    console.error('Error obteniendo reservas:', err);
                }
            }

            // Filtrar horarios disponibles para entrada
            entryTimes.forEach(time => {
                let isReserved = reservedTimes.some(res => time >= res.entry && time < res.exit);
                if (!isReserved) {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    entrySelect.appendChild(option);
                }
            });

            // Actualizar horas de salida según la entrada seleccionada
            updateExitTimes();
        }

        function updateExitTimes() {
            const entryTime = document.getElementById('entry-time').value;
            const exitSelect = document.getElementById('exit-time');
            const date = document.getElementById('date').value;
            exitSelect.innerHTML = '<option value="">Selecciona hora de salida</option>';

            let reservedTimes = [];
            if (date) {
                try {
                    fetch(`/reservations/date?date=${date}`, { credentials: 'include' })
                        .then(res => res.json())
                        .then(reservations => {
                            reservedTimes = reservations.map(res => ({
                                entry: res.entryTime,
                                exit: res.exitTime
                            }));
                            populateExitTimes(entryTime, reservedTimes);
                        })
                        .catch(err => {
                            console.error('Error obteniendo reservas:', err);
                            populateExitTimes(entryTime, []);
                        });
                } catch (err) {
                    console.error('Error obteniendo reservas:', err);
                    populateExitTimes(entryTime, []);
                }
            } else {
                populateExitTimes(entryTime, []);
            }
        }

        function populateExitTimes(entryTime, reservedTimes) {
            const exitSelect = document.getElementById('exit-time');
            exitSelect.innerHTML = '<option value="">Selecciona hora de salida</option>';

            // Filtrar horas de salida posteriores a la hora de entrada
            const entryIndex = allTimes.indexOf(entryTime);
            const availableExitTimes = entryTime ? exitTimes.filter((time, index) => allTimes.indexOf(time) > entryIndex) : exitTimes;

            availableExitTimes.forEach(time => {
                let isReserved = reservedTimes.some(res => time > res.entry && time <= res.exit);
                if (!isReserved) {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    exitSelect.appendChild(option);
                }
            });
        }

        // Cargar datos del usuario para sidebar
        async function loadUserData() {
            try {
                const res = await fetch('/user', { credentials: 'include' });
                if (!res.ok) throw new Error(`Error al obtener usuario: ${res.status}`);
                const data = await res.json();
                document.getElementById('user-name-sidebar').textContent = data.name || 'Usuario';
                if (data.profileImage) {
                    document.getElementById('sidebar-user-img').src = data.profileImage;
                }
            } catch (err) {
                console.error('Error cargando datos del usuario:', err);
                document.getElementById('user-name-sidebar').textContent = 'Usuario';
                document.getElementById('sidebar-user-img').src = '/img/default-profile.png';
            }
        }

        // Poblar select de docentes
        async function loadTeachersSelect() {
            try {
                const res = await fetch('/teachers', { credentials: 'include' });
                if (!res.ok) throw new Error(`Error al obtener docentes: ${res.status}`);
                const teachers = await res.json();
                const select = document.getElementById('teacher');
                select.innerHTML = '<option value="">Selecciona un docente</option>';
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher._id;
                    option.textContent = teacher.name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error cargando docentes:', err);
                const select = document.getElementById('teacher');
                select.innerHTML = '<option value="">Error al cargar docentes</option>';
            }
        }

        // Guardar reserva
        document.getElementById('reservationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            // Convertir FormData a objeto
            const body = {};
            formData.forEach((value, key) => {
                body[key] = value;
            });

            const message = document.getElementById('reservation-message');

            // Validaciones
            const entryTime = body.entryTime;
            const exitTime = body.exitTime;
            const date = body.date;

            if (entryTime >= exitTime) {
                message.classList.remove('alert-success', 'd-none');
                message.classList.add('alert-danger');
                message.textContent = 'La hora de entrada debe ser anterior a la hora de salida.';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            if (date < today) {
                message.classList.remove('alert-success', 'd-none');
                message.classList.add('alert-danger');
                message.textContent = 'La fecha no puede ser anterior a hoy.';
                return;
            }

            try {
                const res = await fetch('/reserve/create', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: 'Error del servidor' }));
                    throw new Error(errorData.error || `Error: ${res.status}`);
                }

                const data = await res.json();
                message.classList.remove('alert-danger', 'd-none');
                message.classList.add('alert-success');
                message.textContent = data.message || 'Reserva creada exitosamente';
                e.target.reset();
                setTimeout(() => { window.location.href = '/reservations/manage'; }, 2000);
            } catch (err) {
                console.error('Error guardando reserva:', err);
                message.classList.remove('alert-success', 'd-none');
                message.classList.add('alert-danger');
                message.textContent = err.message || 'Error del servidor. Intenta de nuevo más tarde.';
            }
        });
    </script>
</body>
</html>